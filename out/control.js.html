<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: control.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: control.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var request = require('request');
var deferred = require('deferred');
var parseString = require('xml2js').parseString;


// The Module Constructor, needs the ip as parameter : e.g. new Yamaha("192.168.0.15")

/**
 * The Yamaha Module Constructor.
 * @constructor
 * @param {string} ip - The ip of the yamaha receiver.
 */
function Yamaha(ip) 
{
    this.ip = ip;
}


Yamaha.prototype.powerOn = function(to){
	var command = '&lt;YAMAHA_AV cmd="PUT">&lt;Main_Zone>&lt;Power_Control>&lt;Power>On&lt;/Power>&lt;/Power_Control>&lt;/Main_Zone>&lt;/YAMAHA_AV>';
	return this.SendXMLToReceiver(command);
};

Yamaha.prototype.powerOff = function(to){
	var command = '&lt;YAMAHA_AV cmd="PUT">&lt;Main_Zone>&lt;Power_Control>&lt;Power>Standby&lt;/Power>&lt;/Power_Control>&lt;/Main_Zone>&lt;/YAMAHA_AV>';
	return this.SendXMLToReceiver(command);
};


Yamaha.prototype.setVolumeTo = function(to){
	var command = '&lt;YAMAHA_AV cmd="PUT">&lt;Main_Zone>&lt;Volume>&lt;Lvl>&lt;Val>'+to+'&lt;/Val>&lt;Exp>1&lt;/Exp>&lt;Unit>dB&lt;/Unit>&lt;/Lvl>&lt;/Volume>&lt;/Main_Zone>&lt;/YAMAHA_AV>';
	return this.SendXMLToReceiver(command);
};

Yamaha.prototype.volumeUp = function(by){
	return this.adjustVolumeBy(by);
};

Yamaha.prototype.volumeDown= function(by){
	return this.adjustVolumeBy(-by);
};

Yamaha.prototype.setMainInputTo = function(to){
	var command = '&lt;YAMAHA_AV cmd="PUT">&lt;Main_Zone>&lt;Input>&lt;Input_Sel>'+to+'&lt;/Input_Sel>&lt;/Input>&lt;/Main_Zone>&lt;/YAMAHA_AV>';
	return this.SendXMLToReceiver(command);
};

// Navigates and selects the #number of the webradio favorites
Yamaha.prototype.switchToFavoriteNumber = function(number){
	var self = this;
	self.powerOn().done(delay(2,function(){

		console.log("powerOn");
		self.setMainInputTo("NET RADIO").done(delay(2, function(){
			console.log("NET RADIO");
			self.selectWebRadioListWithNumber(1).done(delay(2, function(){
				console.log("Selected Favorites");
				self.selectWebRadioListWithNumber(number).done(function(){
					console.log("Callback Hell accomplished");
				});
			}));

		}));
	}));
};

Yamaha.prototype.SendXMLToReceiver= function(xml){
	var d = deferred();
	var promise = request.post(
	    {
	    	method: 'POST', 
		    uri: 'http://'+this.ip+'/YamahaRemoteControl/ctrl',
		    body:xml
		},
	    function (error, response, body) {
	        if (!error &amp;&amp; response.statusCode == 200) {
	            d.resolve(body);
	        }else{
	        	if (error) d.reject(error);
	        	else d.reject(response.statusCode);	
	        }
	        if (error){
	        	console.log(error);
	        	d.reject(error);	
	        }
	    }
	);

	return d.promise;

};

Yamaha.prototype.getColor = function()
{
    return "The receiver is blue";
};



Yamaha.prototype.getBasicInfo = function(){
	var d = deferred();
	var command = '&lt;YAMAHA_AV cmd="GET">&lt;Main_Zone>&lt;Basic_Status>GetParam&lt;/Basic_Status>&lt;/Main_Zone>&lt;/YAMAHA_AV>';
	this.SendXMLToReceiver(command).done(function(xmlresult){
		parseString(xmlresult, function (err, info) {
			enrichBasicInfo(info);
			d.resolve(info);
		});
	}, function (err) {
		d.reject(err);
	});
	return d.promise;
};


Yamaha.prototype.getSystemConfig = function(){
	var d = deferred();
	var command = '&lt;YAMAHA_AV cmd="GET">&lt;System>&lt;Config>GetParam&lt;/Config>&lt;/System>&lt;/YAMAHA_AV>';
	this.SendXMLToReceiver(command).done(function(xmlresult){
		parseString(xmlresult, function (err, info) {
			d.resolve(info);
		});
	}, function (err) {
		d.reject(err);
	});
	return d.promise;
};


Yamaha.prototype.getAvailableInputs = function(){
	var self = this;
	var d = deferred();
	self.getSystemConfig().done(function(info){
		var inputs = [];
		var inputsXML = info.YAMAHA_AV.System[0].Config[0].Name[0].Input[0];
		for (var prop in inputsXML) {
			inputs.push(inputsXML[prop][0]);
		}
		d.resolve(inputs);
	}, function (err) {
		d.reject(err);
	});
	return d.promise;
};



function enrichBasicInfo(basicInfo){

	basicInfo.getVolume = function(){
		return parseInt(basicInfo.YAMAHA_AV.Main_Zone[0].Basic_Status[0].Volume[0].Lvl[0].Val[0]);
	};

	basicInfo.isMuted = function(){
		return basicInfo.YAMAHA_AV.Main_Zone[0].Basic_Status[0].Volume[0].Mute[0] !== "Off";
	};
	

}


Yamaha.prototype.adjustVolumeBy = function(by){
	if (typeof by == 'string' || by instanceof String) by = parseInt(by);
	var self = this;
	var d = deferred();
	self.getBasicInfo().done(function(basicInfo){
		self.setVolumeTo(basicInfo.getVolume()+by).done(d.resolve);
	});
	return d.promise;
};

// &lt;YAMAHA_AV cmd="PUT">&lt;NET_RADIO>&lt;List_Control>&lt;Cursor>Return&lt;/Cursor>&lt;/List_Control>&lt;/NET_RADIO>&lt;/YAMAHA_AV>

// &lt;YAMAHA_AV cmd="GET">&lt;NET_RADIO>&lt;List_Info>GetParam&lt;/List_Info>&lt;/NET_RADIO>&lt;/YAMAHA_AV>

Yamaha.prototype.selectWebRadioListWithNumber = function(number){
	var command = '&lt;YAMAHA_AV cmd="PUT">&lt;NET_RADIO>&lt;List_Control>&lt;Direct_Sel>Line_'+number+'&lt;/Direct_Sel>&lt;/List_Control>&lt;/NET_RADIO>&lt;/YAMAHA_AV>';
	return this.SendXMLToReceiver(command);
};


Yamaha.prototype.setWebRadioToChannel = function(channel){
	return this.selectWebRadioListWithNumber(channel);
};

Yamaha.prototype.getWebRadioChannels = function(){
	var command = '&lt;YAMAHA_AV cmd="GET">&lt;NET_RADIO>&lt;List_Info>GetParam&lt;/List_Info>&lt;/NET_RADIO>&lt;/YAMAHA_AV>';
	return this.SendXMLToReceiver(command);
};

Yamaha.prototype.switchToWebRadioWithName = function(name){
	var self = this;
	self.setMainInputTo("NET RADIO").done(function(){

		self.getWebRadioChannels().done(function(result){
			console.log(result);
			parseString(result, function (err, result) {
			    console.dir(result);
			});

		}, function (err) {
		  console.log("err "+err);
		});

	});

};



var yamaha = new Yamaha("192.168.0.25");
yamaha.getAvailableInputs();
// yamaha.volumeUp("35");
// yamaha.switchToFavoriteNumber(1);

// This is needed, because the yamaha has a stateful api - yeah ...
function delay(delayInS, callAfterDelay){
	return function(){
		setTimeout(function(){
			callAfterDelay();
		}, delayInS*1000);
	};
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="Yamaha.html">Yamaha</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Sat Sep 06 2014 00:59:33 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
